name: Deploy to Production

on:
  push:
    branches:
      - prod

env:
  APP_NAME: nashville-software-collective
  APP_DIR: /opt/nashville-software-collective
  DOCKER_IMAGE: nashville-software-collective
  CONTAINER_NAME: nashville-software-collective
  CONTAINER_PORT: 8082
  DOMAIN: nashvillesoftwarecollective.com
  CERT_EMAIL: nashvillesoftwarecollective@gmail.com
  NGINX_SITE_NAME: nashville-software-collective

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        run: |
          ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << EOF
            # Application configuration variables
            APP_NAME="${{ env.APP_NAME }}"
            APP_DIR="${{ env.APP_DIR }}"
            DOCKER_IMAGE="${{ env.DOCKER_IMAGE }}"
            CONTAINER_NAME="${{ env.CONTAINER_NAME }}"
            CONTAINER_PORT="${{ env.CONTAINER_PORT }}"
            DOMAIN="${{ env.DOMAIN }}"
            CERT_EMAIL="${{ env.CERT_EMAIL }}"
            NGINX_SITE_NAME="${{ env.NGINX_SITE_NAME }}"
            
            # Create directory if it doesn't exist
            mkdir -p $APP_DIR
            cd $APP_DIR
            
            # Prepare git repository URL (use HTTPS, with PAT if available)
            REPO_URL="https://github.com/${{ github.repository }}.git"
            if [ -n "${{ secrets.GITHUB_PAT }}" ]; then
              REPO_URL="https://${{ secrets.GITHUB_PAT }}@github.com/${{ github.repository }}.git"
            fi
            
            # Handle git repository setup
            if [ -d .git ]; then
              echo "Updating existing git repository..."
              # Check if git repo is valid
              if ! git rev-parse --git-dir >/dev/null 2>&1; then
                echo "Git repository is corrupted. Clearing and cloning fresh..."
                cd ..
                sudo rm -rf $APP_NAME
                mkdir -p $APP_NAME
                cd $APP_NAME
                git clone $REPO_URL .
                git checkout prod || git checkout -b prod
              else
                # Remove broken origin if it exists but is invalid
                if ! git remote get-url origin >/dev/null 2>&1; then
                  git remote remove origin 2>/dev/null || true
                  git remote add origin $REPO_URL
                else
                  git remote set-url origin $REPO_URL
                fi
                git fetch origin || { 
                  echo "ERROR: Failed to fetch from origin. Clearing and cloning fresh..."
                  cd ..
                  sudo rm -rf $APP_NAME
                  mkdir -p $APP_NAME
                  cd $APP_NAME
                  git clone $REPO_URL .
                  git checkout prod || git checkout -b prod
                }
                if [ -d .git ]; then
                  git reset --hard origin/prod || { echo "ERROR: Failed to reset to origin/prod"; exit 1; }
                  git clean -fd
                  echo "Git repository updated successfully"
                fi
              fi
            elif [ "$(ls -A . 2>/dev/null)" ]; then
              echo "Directory exists but is not a git repository. Clearing and cloning fresh..."
              cd ..
              sudo rm -rf $APP_NAME
              mkdir -p $APP_NAME
              cd $APP_NAME
              git clone $REPO_URL .
              git checkout prod || git checkout -b prod
            else
              echo "Cloning repository for first time..."
              git clone $REPO_URL .
              git checkout prod || git checkout -b prod
            fi
            
            echo "Verifying we have the latest code..."
            git log -1 --oneline
            echo "Verifying angular.json exists and is valid..."
            if [ -f angular.json ]; then
              echo "angular.json found, checking budgets:"
              grep -A 15 '"budgets"' angular.json || echo "No budgets found"
            else
              echo "ERROR: angular.json not found!"
              exit 1
            fi
            
            # Build and start Docker container first
            echo "Building and starting Docker container..."
            docker compose down || true
            docker rmi $DOCKER_IMAGE:latest || true
            
            if ! docker compose up -d --build; then
              echo "ERROR: Docker build or start failed"
              echo "Checking angular.json on server:"
              cat angular.json | grep -A 20 '"budgets"' || echo "angular.json not found or invalid"
              docker compose logs
              exit 1
            fi
            
            # Wait for container to be ready
            echo "Waiting for container to be ready..."
            sleep 10
            
            CONTAINER_READY=false
            for i in {1..30}; do
              if docker ps | grep -q $CONTAINER_NAME && curl -f http://127.0.0.1:$CONTAINER_PORT > /dev/null 2>&1; then
                echo "Container is ready"
                CONTAINER_READY=true
                break
              fi
              echo "Waiting for container... ($i/30)"
              if [ $i -eq 30 ]; then
                echo "ERROR: Container failed to start or become ready"
                docker ps -a | grep $CONTAINER_NAME
                docker logs $CONTAINER_NAME || true
                exit 1
              fi
              sleep 2
            done
            
            # Deploy nginx configuration and handle SSL certificates
            if [ -f .github/workflows/deploy-nginx.sh ]; then
              chmod +x .github/workflows/deploy-nginx.sh
              .github/workflows/deploy-nginx.sh "$APP_NAME" "$APP_DIR" "$NGINX_SITE_NAME" "$DOMAIN" "$CERT_EMAIL" "$CONTAINER_PORT"
            elif [ -f nginx-server.conf ]; then
              echo "Warning: deploy-nginx.sh not found, nginx config may not be deployed correctly"
            fi
            
            docker image prune -f
            
            sleep 5
            docker ps | grep $CONTAINER_NAME
          EOF

      - name: Verify deployment
        run: |
          sleep 10
          curl -f http://${{ secrets.SERVER_HOST }}:${{ env.CONTAINER_PORT }} || exit 1

