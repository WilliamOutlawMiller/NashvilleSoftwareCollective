name: Deploy to Production

on:
  push:
    branches:
      - prod

env:
  APP_NAME: nashville-software-collective
  APP_DIR: /opt/nashville-software-collective
  DOCKER_IMAGE: nashville-software-collective
  CONTAINER_NAME: nashville-software-collective
  CONTAINER_PORT: 8082
  DOMAIN: nashvillesoftwarecollective.com
  CERT_EMAIL: nashvillesoftwarecollective@gmail.com
  NGINX_SITE_NAME: nashville-software-collective
  REPO_URL: https://github.com/${{ github.repository }}.git

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        run: |
          ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << EOF
            # Application configuration variables
            APP_NAME="${{ env.APP_NAME }}"
            APP_DIR="${{ env.APP_DIR }}"
            DOCKER_IMAGE="${{ env.DOCKER_IMAGE }}"
            CONTAINER_NAME="${{ env.CONTAINER_NAME }}"
            CONTAINER_PORT="${{ env.CONTAINER_PORT }}"
            DOMAIN="${{ env.DOMAIN }}"
            CERT_EMAIL="${{ env.CERT_EMAIL }}"
            NGINX_SITE_NAME="${{ env.NGINX_SITE_NAME }}"
            
            # Prepare git repository URL (use HTTPS, with PAT if available)
            REPO_URL="${{ env.REPO_URL }}"
            GITHUB_PAT="${{ secrets.GITHUB_PAT }}"
            if [ -n "$GITHUB_PAT" ]; then
              # Insert PAT into URL: https://PAT@github.com/owner/repo.git
              REPO_URL=$(echo "$REPO_URL" | sed "s|https://|https://$GITHUB_PAT@|")
            fi
            echo "Using REPO_URL: ${REPO_URL%%@*}" # Show URL without PAT for security
            
            # Handle git repository setup using script
            # First, get the script from the repo (clone to temp location if needed)
            SCRIPT_PATH=""
            TEMP_SCRIPT_DIR=""
            
            if [ -d $APP_DIR/.git ] && [ -f $APP_DIR/.github/workflows/deploy-git.sh ]; then
              echo "Using existing deploy-git.sh script from $APP_DIR"
              SCRIPT_PATH="$APP_DIR/.github/workflows/deploy-git.sh"
            else
              # Clone repo to temp location to get the script
              TEMP_SCRIPT_DIR="/tmp/deploy-$$"
              mkdir -p "$TEMP_SCRIPT_DIR"
              
              git clone "$REPO_URL" "$TEMP_SCRIPT_DIR"
              cd "$TEMP_SCRIPT_DIR"
              if git show-ref --verify --quiet refs/remotes/origin/prod 2>/dev/null; then
                git checkout prod
              fi
              if [ -f .github/workflows/deploy-git.sh ]; then
                SCRIPT_PATH="$TEMP_SCRIPT_DIR/.github/workflows/deploy-git.sh"
              else
                echo "ERROR: deploy-git.sh not found in repository"
                exit 1
              fi
            fi
            
            chmod +x "$SCRIPT_PATH"
            "$SCRIPT_PATH" "$APP_NAME" "$APP_DIR" "$REPO_URL"
            rm -rf "$TEMP_SCRIPT_DIR" 2>/dev/null || true
            
            # Build and start Docker container first
            echo "Building and starting Docker container..."
            docker compose down || true
            docker rmi $DOCKER_IMAGE:latest || true
            
            if ! docker compose up -d --build; then
              echo "ERROR: Docker build or start failed"
              echo "Checking angular.json on server:"
              cat angular.json | grep -A 20 '"budgets"' || echo "angular.json not found or invalid"
              docker compose logs
              exit 1
            fi
            
            # Wait for container to be ready
            echo "Waiting for container to be ready..."
            sleep 10
            
            CONTAINER_READY=false
            for i in {1..30}; do
              if docker ps | grep -q $CONTAINER_NAME && curl -f http://127.0.0.1:$CONTAINER_PORT > /dev/null 2>&1; then
                echo "Container is ready"
                CONTAINER_READY=true
                break
              fi
              echo "Waiting for container... ($i/30)"
              if [ $i -eq 30 ]; then
                echo "ERROR: Container failed to start or become ready"
                docker ps -a | grep $CONTAINER_NAME
                docker logs $CONTAINER_NAME || true
                exit 1
              fi
              sleep 2
            done
            
            # Deploy nginx configuration and handle SSL certificates
            if [ -f $APP_DIR/.github/workflows/deploy-nginx.sh ]; then
              chmod +x $APP_DIR/.github/workflows/deploy-nginx.sh
              sudo $APP_DIR/.github/workflows/deploy-nginx.sh "$APP_NAME" "$APP_DIR" "$NGINX_SITE_NAME" "$DOMAIN" "$CERT_EMAIL" "$CONTAINER_PORT"
            elif [ -f $APP_DIR/nginx-server.conf ]; then
              echo "Warning: deploy-nginx.sh not found, nginx config may not be deployed correctly"
            fi
            
            docker image prune -f
            
            sleep 5
            docker ps | grep $CONTAINER_NAME
          EOF

      - name: Verify deployment
        run: |
          sleep 10
          curl -f http://${{ secrets.SERVER_HOST }}:${{ env.CONTAINER_PORT }} || exit 1

